{% extends "mapas/base.html" %}

{% load geojson_tags leaflet_tags  %}

{% block inhead %}
{% leaflet_js %}
{% leaflet_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">

<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
{% endblock %}

{% block sidebar %}

<h1>{{cidade.nome}}</h1>

<em>{{cidade.ibge}}</em>
<p><i>{{cidade.regiao}}</i>
</p>

{% endblock %}
{% block conteudo %} 
  

<script>
    function map_init(map, options) { 
       var collection = {{ cidade|geojsonfeature:":geometria,nome,"|safe }};
        var geojson = L.geoJson(collection.features).addTo(map); 
        map.addControl(geojson);
        map.fitBounds(geojson.getBounds());
        load_estabelecimentos(map)
    }

    function load_estabelecimentos(map){
        //var markers = L.contr
        var markers = L.markerClusterGroup();
        axios.get("{% url 'mapa:estabelecimentocidade' cidade.ibge %}").then(
            function (response) { 
                for(let dado of response.data)
                {
                    var popup = `<p><b>${dado.nome}</b><br>
                        <span style="margin-top: 1px;">${dado.tipo}</span><br>
                        <span style="float: right">CNES ${dado.cnes}</span>
                        </p>
                    
                    <p style="clear: both;"><i>${dado.endereco.replace('\n', '<br>')}</i></p>`
                    var marker = L.marker(dado.coordenadas).bindPopup(popup)
                    markers.addLayer(marker);
                }
                map.addLayer(markers);
            })
    }

</script>

{% leaflet_map "yourmap" callback="window.map_init" %}

{% endblock %}